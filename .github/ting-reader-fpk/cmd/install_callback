#!/bin/bash

### This script is called after the user installs the application.

SECRET_FILE="${TRIM_PKGETC}/jwt_secret"

# Use user input from wizard
if [ -n "$wizard_jwt_secret" ] && [ "$wizard_jwt_secret" != "" ]; then
    JWT_SECRET="$wizard_jwt_secret"
else
    # Should not happen if wizard validates input, but as a fallback:
    export LC_ALL=C
    JWT_SECRET=$(head -c 512 /dev/urandom | tr -dc 'a-zA-Z0-9' | head -c 32)
    if [ -z "$JWT_SECRET" ]; then
        if command -v openssl >/dev/null 2>&1; then
            JWT_SECRET=$(openssl rand -hex 16)
        else
            JWT_SECRET="defaultsecret$(date +%s)$RANDOM"
        fi
    fi
fi

# Save to persistent config
mkdir -p "$(dirname "$SECRET_FILE")"
echo "$JWT_SECRET" > "$SECRET_FILE"

# Create .env file for docker-compose
ENV_FILE="${TRIM_APPDEST}/docker/.env"
# Also support app/docker path structure
if [ ! -d "$(dirname "$ENV_FILE")" ] && [ -d "${TRIM_APPDEST}/app/docker" ]; then
    ENV_FILE="${TRIM_APPDEST}/app/docker/.env"
fi

if [ -d "$(dirname "$ENV_FILE")" ]; then
    echo "TING_SECURITY__JWT_SECRET=${JWT_SECRET}" > "$ENV_FILE"
    echo "wizard_jwt_secret=${JWT_SECRET}" >> "$ENV_FILE"
    echo "Environment file created at: $ENV_FILE"
    
    # CRITICAL FIX: Directly replace the variable in docker-compose.yaml
    # The system might not pick up .env file automatically or variable substitution might fail
    # if the variable is not passed from the wizard.
    # By replacing ${wizard_jwt_secret} with the actual value, we guarantee it works.
    
    DOCKER_COMPOSE_FILE="$(dirname "$ENV_FILE")/docker-compose.yaml"
    
    if [ -f "$DOCKER_COMPOSE_FILE" ]; then
        # Use simple sed replacement
        # Escape special chars: & / \
        ESCAPED_SECRET=$(printf '%s\n' "$JWT_SECRET" | sed -e 's/[\/&]/\\&/g')
        
        # Replace ${wizard_jwt_secret} with actual secret
        sed -i "s|\${wizard_jwt_secret}|$ESCAPED_SECRET|g" "$DOCKER_COMPOSE_FILE"
        
        echo "Updated docker-compose.yaml with JWT Secret directly."
    else
        echo "Warning: docker-compose.yaml not found at $DOCKER_COMPOSE_FILE"
    fi
else
    echo "Error: Docker directory not found. Expected at $(dirname "$ENV_FILE") or ${TRIM_APPDEST}/app/docker"
fi

exit 0