# 更新日志 (Changelog)

所有关于 **Ting Reader** 的重要变更都将记录在此文件中。

## [1.0.10] - 2026-02-16

### 🚀 性能与刮削优化
- **XM 扫描性能大幅提升**：重构了 `.xm` 文件的扫描逻辑，实现了**文件头按需读取**（Partial Read），不再将整个大文件加载到内存中。对于 50MB+ 的音频文件，扫描时的内存占用降低了 95% 以上，显著提高了大批量扫描的稳定性。
- **智能文件名刮削**：新增了**文件名元数据提取**功能。当音频文件（如 `.m4a`）缺失内置标签且文件夹名称为 "Unknown Book" 时，系统会自动分析文件名（支持 `作者 - 书名 - 章节` 等多种格式），精准提取书名和作者，解决了格式转换后书籍无法识别的问题。
- **章节名称清洗增强**：优化了章节标题的清洗算法，能够智能识别并去除文件名中的冗余信息（如重复的书名、作者名），仅保留核心章节名称，让章节列表更加清爽易读。

### 🎨 前端体验优化
- **操作逻辑改进**：优化了前端交互逻辑，提升了用户操作的流畅度。

## [1.0.9] - 2026-02-15

### 🚀 优化与改进
- **缓存逻辑优化**：优化了服务端缓存处理逻辑。
- **界面优化**：同步优化了 Web 前端书架和收藏页面的空状态显示。

## [1.0.8] - 2026-02-11

### 🚀 性能与内存优化
- **智能内存管理**：大幅优化了 XM 解密和扫描过程中的内存占用。
  - **WASM 按需加载**：重构了解密核心，从全局单例改为按需实例化，彻底解决了处理大文件后内存无法回落的问题（内存泄漏修复）。
  - **主动垃圾回收**：在扫描和播放流程中引入了激进的内存释放策略，处理完文件后立即释放缓冲区，显著降低了并发峰值。
- **扫描精准度提升**：将全量读取的阈值从 10MB 提升至 20MB，确保部分非标准编码的 MP3/M4A 文件能被准确读取时长和元数据。

## [1.0.7] - 2026-02-10

### 📱 Android 客户端适配
- **网络权限修复**：修复了 Android 9.0+ 设备默认禁止明文 HTTP 流量导致无法连接局域网服务器的问题（已在 App 侧添加 `usesCleartextTraffic` 配置）。

### 🛠️ 扫描器稳定性与逻辑升级
- **无缝路径迁移**：支持**“智能身份找回”**功能。当您修改存储库的根目录（例如从 `/` 改为 `/Book`）或移动书籍位置时，系统会自动识别同名书籍，**保留所有阅读进度和收藏记录**，无需重新刮削。
- **并发控制修复**：
  - 彻底解决了“双重任务”问题，确保每次配置修改只触发一个扫描任务。
  - 引入了 `AbortController` 深度中断机制，旧任务会在毫秒级内被新任务终止，杜绝数据库冲突。
- **容错增强**：修复了 `FOREIGN KEY constraint failed` 数据库崩溃问题，优化了删除逻辑的顺序，确保在清理无效数据时系统依然稳定。

## [1.0.6] - 2026-02-08

### 🛠️ 修复与优化
- **前端路由修复**：修复了在非根路径下刷新页面导致白屏（`MIME type error`）的问题，将前端构建 `base` 路径调整为绝对路径 `/`。

## [1.0.5] - 2026-02-06
- **架构升级**：完全分离桌面端代码到独立项目 `ting-reader-client`，主项目专注于服务端和 Web 前端。
- **桌面端支持**：为新的纯客户端桌面应用提供 API 支持（包括 302 重定向解析、跨域头优化等）。
- **清理**：移除了主项目中遗留的 Electron 相关构建脚本和依赖。

## [1.0.4] - 2026-02-05

### 🎵 音频兼容性增强
- **全格式支持**：除了基础的 MP3/M4A，现在完美支持 **WMA, FLAC, OGG, OPUS, AAC, M4B** 等格式。
- **实时转码**：引入 **FFmpeg** 实时转码引擎。当检测到浏览器不支持的音频格式（如 WMA/FLAC）时，后端会自动将其转码为 MP3 流进行播放，无需预先处理文件。
- **环境升级**：Docker 镜像现已预装 FFmpeg，开箱即用，无需额外配置。

### ✨ 新特性
- **书架筛选**：书架页面新增了**媒体库选择器**，支持按来源库快速筛选展示书籍，管理多库资源更便捷。
- **高级筛选**：重构了搜索页面的筛选体验，引入**聚合筛选面板**，支持按媒体库、标签、作者及演播者进行多维度组合筛选，并优化了移动端/桌面端的交互体验。

### 🛠️ 修复与优化
- **扫描器升级**：优化了文件扫描逻辑，将 .m4b, .ogg, .opus, .wma 等格式加入白名单，支持元数据解析。

---

## [1.0.3] - 2026-02-05

### ✨ 外挂组件 (Widget)
- **多模式嵌入**：新增外挂播放器组件，支持“私有模式”（带 Token 免登录）和“公开模式”（需登录）。
- **灵活布局**：
  - **标准嵌入**：随文档流展示。
  - **吸底模式**：固定在屏幕底部。
  - **悬浮模式**：右下角胶囊悬浮，支持响应式垂直布局（手机端自动适配）。
- **沉浸式体验**：
  - 支持点击 Widget 封面进入全屏沉浸式播放界面。
  - 优化了全屏/小窗切换动画及状态同步。
- **高度定制**：
  - 支持在设置页面一键复制包含定位样式的完整 HTML 代码。
  - 支持注入自定义 CSS 以修改 Widget 内部样式（如透明背景、隐藏按钮等）。

### 🛠️ 体验优化
- **播放器逻辑**：重构了播放器响应式布局逻辑，移除了不稳定的 JS 监听，改用纯 CSS 媒体查询，彻底解决了白屏和布局挤压问题。
- **文档更新**：新增了 [Widget 集成指南](https://github.com/dqsq2e2/ting-reader/wiki/WIDGET_GUIDE)。

---

## [1.0.2] - 2026-02-03

### ✨ 播放器功能优化
- **自定义睡眠定时**：支持设置任意分钟数的倒计时，并优化了 UI 布局，解决了按钮挤压问题。
- **定时器智能同步**：倒计时现在会随播放状态自动暂停/恢复。
- **输入安全性**：限制自定义定时输入为正整数，禁止负数输入。

### 🚀 UI/UX 修复
- **沉浸式进度条**：修复了进度指示器（时间药丸）固定不移动的问题，现在会随播放进度平滑滑动。
- **播放状态同步**：通过监听底层音频事件，确保图标状态（播放/暂停）与实际播放情况实时同步，修复了中断后图标不更新的问题。

---

## [1.0.1] - 2026-02-03

### ✨ 新特性
- **媒体库同步清理**：同步时自动检测并清理磁盘上已不存在的书籍和章节记录。
- **单本书籍管理**：
  - 支持从书架手动删除书籍。
  - 本地源支持在删除时同步物理删除源文件。
  - 删除书籍时自动清理关联的所有缓存（`.bin`）和预加载文件。
- **智能合并去重**：扫描时支持根据音频标签（Album）跨文件夹合并同一专辑，避免重复创建书籍。
- **自动初始化扫描**：首次添加媒体库后自动触发一次同步任务，无需手动点击。

### 🚀 优化与改进
- **缓存机制优化**：本地存储源（非加密文件）改为直接流式传输，不再占用额外的缓存空间。
- **刮削逻辑增强**：优化了喜马拉雅刮削器，支持更精准的描述清理和元数据提取。
- **UI 改进**：
  - 后台管理菜单顺序调整：任务日志移动至库管理之后，方便查看同步状态。
  - 增加删除书籍确认弹窗及危险操作提示。
- **版本管理**：项目整体版本更新至 1.0.1。

---

## [1.0.0] - 2026-02-03
- 初始版本发布。
